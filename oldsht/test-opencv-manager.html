<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>OpenCV Manager Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .loading { background-color: #fff3cd; color: #856404; }
        .ready { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        canvas {
            border: 1px solid #ddd;
            margin: 10px 0;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OpenCV Manager Test</h1>
        
        <div id="status" class="status loading">
            🔄 Loading OpenCV.js...
        </div>
        
        <div class="test-section">
            <h3>Basic Tests</h3>
            <button id="testReady" disabled>Test Ready Status</button>
            <button id="testCV" disabled>Test CV Object</button>
            <button id="testMat" disabled>Test Mat Creation</button>
            <div id="basicResults"></div>
        </div>
        
        <div class="test-section">
            <h3>Image Processing Test</h3>
            <input type="file" id="imageInput" accept="image/*" disabled>
            <br>
            <canvas id="originalCanvas" width="300" height="200"></canvas>
            <canvas id="processedCanvas" width="300" height="200"></canvas>
            <br>
            <button id="testThreshold" disabled>Apply Adaptive Threshold</button>
            <div id="imageResults"></div>
        </div>
        
        <div class="test-section">
            <h3>Performance Test</h3>
            <button id="testPerformance" disabled>Run Performance Test</button>
            <div id="performanceResults"></div>
        </div>
    </div>

    <!-- Load OpenCV and our manager -->
    <script async src="lib/opencv.js"></script>
    <script type="module" src="lib/opencv-manager.js"></script>
    
    <script>
        // Test variables
        let testImage = null;
        
        // UI elements
        const statusDiv = document.getElementById('status');
        const basicResults = document.getElementById('basicResults');
        const imageResults = document.getElementById('imageResults');
        const performanceResults = document.getElementById('performanceResults');
        
        // Buttons
        const testReadyBtn = document.getElementById('testReady');
        const testCVBtn = document.getElementById('testCV');
        const testMatBtn = document.getElementById('testMat');
        const testThresholdBtn = document.getElementById('testThreshold');
        const testPerformanceBtn = document.getElementById('testPerformance');
        const imageInput = document.getElementById('imageInput');
        
        // Canvases
        const originalCanvas = document.getElementById('originalCanvas');
        const processedCanvas = document.getElementById('processedCanvas');
        
        // Wait for OpenCV manager to be available
        function waitForOpenCVManager() {
            if (window.openCVManager) {
                setupTests();
            } else {
                setTimeout(waitForOpenCVManager, 100);
            }
        }
        
        function setupTests() {
            // Set up OpenCV manager callbacks
            window.openCVManager.onReady((cv) => {
                statusDiv.className = 'status ready';
                statusDiv.innerHTML = '✅ OpenCV.js is ready!';
                
                // Enable all test buttons
                testReadyBtn.disabled = false;
                testCVBtn.disabled = false;
                testMatBtn.disabled = false;
                testThresholdBtn.disabled = false;
                testPerformanceBtn.disabled = false;
                imageInput.disabled = false;
                
                console.log('OpenCV Manager Test: Ready!');
            });
            
            window.openCVManager.onError((error) => {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '❌ OpenCV.js failed to load: ' + error.message;
            });
        }
        
        // Test functions
        testReadyBtn.onclick = () => {
            const isReady = window.openCVManager.ready();
            basicResults.innerHTML = `<p>Ready status: <strong>${isReady}</strong></p>`;
        };
        
        testCVBtn.onclick = () => {
            const cv = window.openCVManager.getCV();
            const hasCV = cv !== null;
            const version = hasCV && cv.getBuildInformation ? 'Available' : 'Not available';
            basicResults.innerHTML = `<p>CV object: <strong>${hasCV}</strong><br>Version info: <strong>${version}</strong></p>`;
        };
        
        testMatBtn.onclick = () => {
            try {
                const cv = window.openCVManager.getCV();
                const mat = new cv.Mat(100, 100, cv.CV_8UC3);
                const success = mat.rows === 100 && mat.cols === 100;
                mat.delete();
                basicResults.innerHTML = `<p>Mat creation: <strong>${success ? 'Success' : 'Failed'}</strong></p>`;
            } catch (error) {
                basicResults.innerHTML = `<p>Mat creation: <strong>Error - ${error.message}</strong></p>`;
            }
        };
        
        // Image input handler
        imageInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const img = new Image();
                img.onload = () => {
                    testImage = img;
                    
                    // Draw original image
                    originalCanvas.width = Math.min(img.width, 300);
                    originalCanvas.height = Math.min(img.height, 200);
                    const ctx = originalCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, originalCanvas.width, originalCanvas.height);
                    
                    imageResults.innerHTML = '<p>Image loaded successfully!</p>';
                };
                img.src = URL.createObjectURL(file);
            }
        };
        
        testThresholdBtn.onclick = () => {
            if (!testImage) {
                imageResults.innerHTML = '<p><strong>Please load an image first!</strong></p>';
                return;
            }
            
            try {
                const startTime = performance.now();
                const resultCanvas = window.openCVManager.applyAdaptiveThreshold(testImage);
                const endTime = performance.now();
                
                if (resultCanvas) {
                    // Display result
                    processedCanvas.width = resultCanvas.width;
                    processedCanvas.height = resultCanvas.height;
                    const ctx = processedCanvas.getContext('2d');
                    ctx.drawImage(resultCanvas, 0, 0);
                    
                    imageResults.innerHTML = `<p><strong>Adaptive threshold applied successfully!</strong><br>Processing time: ${(endTime - startTime).toFixed(2)}ms</p>`;
                } else {
                    imageResults.innerHTML = '<p><strong>Failed to apply adaptive threshold</strong></p>';
                }
            } catch (error) {
                imageResults.innerHTML = `<p><strong>Error: ${error.message}</strong></p>`;
            }
        };
        
        testPerformanceBtn.onclick = () => {
            if (!window.openCVManager.ready()) {
                performanceResults.innerHTML = '<p><strong>OpenCV not ready!</strong></p>';
                return;
            }
            
            try {
                const cv = window.openCVManager.getCV();
                const iterations = 1000;
                
                // Test Mat creation/deletion
                const startTime = performance.now();
                for (let i = 0; i < iterations; i++) {
                    const mat = new cv.Mat(10, 10, cv.CV_8UC1);
                    mat.delete();
                }
                const endTime = performance.now();
                
                const avgTime = (endTime - startTime) / iterations;
                performanceResults.innerHTML = `<p><strong>Performance Test Results:</strong><br>
                    ${iterations} Mat create/delete cycles<br>
                    Total time: ${(endTime - startTime).toFixed(2)}ms<br>
                    Average per operation: ${avgTime.toFixed(4)}ms</p>`;
            } catch (error) {
                performanceResults.innerHTML = `<p><strong>Performance test error: ${error.message}</strong></p>`;
            }
        };
        
        // Start the test setup
        waitForOpenCVManager();
    </script>
</body>
</html> 